-- ============================================
-- PRODUCTION-READY: OPENFLOW POSTGRESQL CDC
-- Customer: [Your Customer Name]
-- Environment: AWS RDS PostgreSQL + Snowflake SPCS
-- Date: 2024
-- ============================================

USE ROLE ACCOUNTADMIN;

-- 1. Create/verify schema
CREATE SCHEMA IF NOT EXISTS OPENFLOW.NETWORKS;
CREATE SCHEMA IF NOT EXISTS OPENFLOW.SECRETS;

-- 2. Create network rule (CORRECTED SYNTAX)
CREATE OR REPLACE NETWORK RULE OPENFLOW.NETWORKS.POSTGRES_NETWORK_RULE
  MODE = EGRESS
  TYPE = HOST_PORT
  VALUE_LIST = ('datalake-dbcluster.cluster-cvmpafjeelau.us-west-2.rds.amazonaws.com');

-- 3. Create external access integration
CREATE OR REPLACE EXTERNAL ACCESS INTEGRATION OPENFLOW_POSTGRES_ACCESS
  ALLOWED_NETWORK_RULES = (OPENFLOW.NETWORKS.POSTGRES_NETWORK_RULE)
  ENABLED = TRUE;

-- 4. Create secret for PostgreSQL credentials
CREATE OR REPLACE SECRET OPENFLOW.SECRETS.POSTGRES_CDC_SECRET
  TYPE = PASSWORD
  USERNAME = 'openflow_cdc'
  PASSWORD = '<YOUR_SECURE_PASSWORD>';

-- 5. Grant to runtime role
GRANT USAGE ON INTEGRATION OPENFLOW_POSTGRES_ACCESS TO ROLE OPENFLOW_RUNTIME_ROLE;
GRANT USAGE ON SECRET OPENFLOW.SECRETS.POSTGRES_CDC_SECRET TO ROLE OPENFLOW_RUNTIME_ROLE;

-- 6. Verification
SHOW NETWORK RULES IN SCHEMA OPENFLOW.NETWORKS;
SHOW EXTERNAL ACCESS INTEGRATIONS;
SHOW SECRETS IN SCHEMA OPENFLOW.SECRETS;

-- Expected Output:
-- Network rule: POSTGRES_NETWORK_RULE (Active)
-- Integration: OPENFLOW_POSTGRES_ACCESS (Enabled)
-- Secret: POSTGRES_CDC_SECRET (Created)
